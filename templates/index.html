<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-VXEHBX2S2V"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }

        gtag('js', new Date());
        gtag('config', 'G-VXEHBX2S2V', {
            send_page_view: true
        });
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Foodly</title>
    <link rel="stylesheet" href="../css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-md);
            background: linear-gradient(135deg, #fcebeb 0%, #e8fcfc 100%);
        }

        .login-card {
            width: 100%;
            max-width: 400px;
            text-align: center;
            padding: var(--spacing-xl);
        }

        .login-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto var(--spacing-lg);
            background: white;
            border-radius: 50%;
            padding: 10px;
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .google-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: var(--radius-full);
            background: white;
            color: var(--text-color);
            font-weight: 500;
            transition: var(--transition);
            margin-top: var(--spacing-xl);
        }

        .google-btn:hover {
            background-color: #f8f8f8;
            box-shadow: var(--shadow-sm);
            transform: translateY(-1px);
        }

        .text-danger {
            color: #dc3545;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .skip-btn {
            display: none;
        }

        /* Hide old one if exists */

        .guest-btn-lg:hover {
            background: #fff5f5 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(255, 107, 107, 0.2);
        }

        /* =========================================
           RESPONSIVE DESIGN 
           ========================================= */

        /* Tablet & Small Laptop Optimization (< 1024px) */
        @media screen and (max-width: 1023px) {
            .login-container {
                padding: var(--spacing-md);
                /* Ensure padding exists */
                /* Flexbox centering is already inherited from desktop styles */
            }

            .login-card {
                /* Maintain center and max-width */
                margin: 0 auto;
            }
        }

        /* Mobile Optimization (< 768px) */
        @media screen and (max-width: 767px) {
            body {
                overflow-y: hidden;
                /* Prevent scrolling on mobile */
            }

            .login-container {
                padding: 0.5rem;
                min-height: 100vh;
                height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .login-card {
                width: 100%;
                max-width: 100%;
                padding: 1rem;
                margin: 0;
                display: flex;
                flex-direction: column;
                justify-content: center;
                /* Ensure it fits securely */
                max-height: 100vh;
            }

            .login-logo {
                width: 60px;
                height: 60px;
                margin-bottom: 0.5rem !important;
                padding: 8px;
            }

            /* Typography Scaling */
            h1 {
                font-size: 1.4rem;
                /* Reduced from 1.5rem */
                margin-bottom: 0.25rem;
            }

            .text-muted {
                font-size: 0.75rem !important;
                /* Reduced from 0.8rem */
                margin-bottom: 0.75rem !important;
                /* Reduce gap */
            }

            /* Compact Inputs & Buttons */
            input,
            button,
            .google-btn,
            .guest-btn-lg {
                width: 100% !important;
                max-width: 100%;
                box-sizing: border-box;
                min-height: 40px !important;
                /* Reduce height from 48px */
                padding: 8px !important;
                font-size: 0.85rem !important;
                /* Reduced from 0.9rem */
            }

            input {
                margin-bottom: 6px !important;
                margin-top: 2px !important;
            }

            .guest-btn-lg {
                margin-bottom: 10px !important;
            }

            .google-btn {
                margin-top: 0.5rem !important;
                gap: 8px;
            }

            /* Override Inline Styles for Vertical Compactness */
            /* Target margins on containers */
            #login-view>div[style*="margin-bottom: 1.5rem"] {
                margin-bottom: 0.5rem !important;
            }

            #login-view>div[style*="margin: 1.5rem 0"] {
                margin: 0.5rem 0 !important;
            }

            /* Register link area */
            div[style*="margin-top: 2rem"] {
                margin-top: 0.5rem !important;
                padding-top: 0.5rem !important;
            }

            /* Admin link area */
            div[style*="margin-top: 20px"] {
                margin-top: 0.5rem !important;
            }

            /* Label adjustments */
            label {
                font-size: 0.75rem !important;
                /* Reduced from 0.8rem */
                margin-bottom: 0 !important;
            }

            /* Adjust forgot password alignment and font size */
            div[style*="margin-bottom: 15px"] {
                margin-bottom: 5px !important;
            }

            div[style*="margin-bottom: 15px"] a {
                font-size: 0.75rem !important;
            }
        }
    </style>
</head>

<body>
    <div class="login-container">
        <div class="card login-card animate-fade-in">
            <div class="login-logo">
                <img src="../images/logo.png" alt="Foodly Logo">
            </div>

            <!-- LOGIN VIEW -->
            <div id="login-view">
                <h1>Welcome to Foodly</h1>
                <p class="text-muted">Order your favorite food for campus delivery.</p>

                <div style="text-align: left; margin-bottom: 1.5rem;">
                    <!-- GUEST BUTTON (Explicitly Above Input) -->
                    <a href="menu.html" class="guest-btn-lg animate-fade-in"
                        style="display: flex; justify-content: center; align-items: center; width: 100%; padding: 12px; border: 1px solid var(--primary-color); background: white; color: var(--primary-color); border-radius: 8px; font-weight: 600; text-decoration: none; margin-bottom: 20px; transition: all 0.3s ease;">
                        Continue as Guest ‚Üí
                    </a>
                    <div id="login-error" class="text-danger"
                        style="display:none; text-align: left; margin-bottom: 1rem;"></div>
                    <div>
                        <label style="font-size: 0.9rem; color: #666; font-weight: 500;">Email</label>
                        <input type="email" id="loginEmail" placeholder="Enter your email" autocomplete="off"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-top: 4px; margin-bottom: 10px;">
                    </div>
                    <div>
                        <label style="font-size: 0.9rem; color: #666; font-weight: 500;">Password</label>
                        <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-top: 4px; margin-bottom: 10px;">
                        <div style="text-align: right; margin-top: -5px; margin-bottom: 15px;">
                            <a href="javascript:void(0)" onclick="handleForgotPassword()"
                                style="font-size: 0.85rem; color: var(--primary-color); text-decoration: none;">Forgot
                                Password?</a>
                        </div>
                    </div>
                    <button class="google-btn" onclick="handleEmailLogin()"
                        style="background: var(--primary-color); color: white; border: none; margin-top: 10px; justify-content: center;">
                        Login
                    </button>
                </div>

                <div style="display: flex; align-items: center; margin: 1.5rem 0;">
                    <div style="flex: 1; height: 1px; background: #eee;"></div>
                    <span style="padding: 0 10px; color: #999; font-size: 0.8rem;">OR</span>
                    <div style="flex: 1; height: 1px; background: #eee;"></div>
                </div>

                <button class="google-btn" id="googleLogin">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google"
                        width="20">
                    Sign in with Google
                </button>

                <!-- Old Guest Link Removed -->
                <div style="margin-top: 20px;">
                    <p class="text-sm text-muted">Or continue as <a href="#" onclick="handleAdminLogin()"
                            style="color: var(--primary-color)">Admin</a></p>
                </div>

                <div style="margin-top: 2rem; border-top: 1px solid #eee; padding-top: 1rem;">
                    <button onclick="showRegister()"
                        style="background: none; border: none; color: var(--primary-color); font-weight: 600; cursor: pointer;">
                        Create New Account
                    </button>
                </div>
            </div>

            <!-- REGISTER VIEW -->
            <div id="register-view" style="display: none;">
                <h1 style="margin-bottom: 1.5rem;">Create Account</h1>

                <div id="register-error" class="text-danger"
                    style="display:none; text-align: left; margin-bottom: 1rem;"></div>

                <div style="text-align: left; display: flex; flex-direction: column; gap: 1rem;">
                    <div>
                        <label style="font-size: 0.9rem; color: #666; font-weight: 500;">Full Name</label>
                        <input type="text" id="regName" placeholder="Enter your name"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-top: 4px;">
                    </div>
                    <div>
                        <label style="font-size: 0.9rem; color: #666; font-weight: 500;">Email</label>
                        <input type="email" id="regEmail" placeholder="Enter your email"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-top: 4px;">
                    </div>
                    <div>
                        <label style="font-size: 0.9rem; color: #666; font-weight: 500;">Mobile Number</label>
                        <input type="tel" id="regPhone" placeholder="Enter 10-digit number" maxlength="10"
                            oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-top: 4px;">
                    </div>
                    <div>
                        <label style="font-size: 0.9rem; color: #666; font-weight: 500;">Password</label>
                        <input type="password" id="regPassword" placeholder="Minimum 6 characters"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-top: 4px;">
                    </div>
                    <div>
                        <label style="font-size: 0.9rem; color: #666; font-weight: 500;">Re-enter Password</label>
                        <input type="password" id="regConfirmPassword" placeholder="Confirm Password"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-top: 4px;">
                    </div>
                </div>

                <button class="google-btn" onclick="handleRegistration()"
                    style="background: var(--primary-color); color: white; border: none; margin-top: 1.5rem; justify-content: center;">
                    Create Account
                </button>

                <div style="margin-top: 1.5rem;">
                    <p class="text-sm text-muted">Already have an account? <a href="#" onclick="showLogin()"
                            style="color: var(--primary-color)">Login</a></p>
                </div>
            </div>

            <!-- FORGOT PASSWORD VIEW -->
            <div id="forgot-password-view" style="display: none;">
                <h1 style="margin-bottom: 20px;">Reset Password</h1>
                <p class="text-muted" style="font-size: 0.9rem; margin-bottom: 20px;">Enter your email to receive a
                    reset link.</p>

                <div style="text-align: left; margin-bottom: 1.5rem;">
                    <div>
                        <label style="font-size: 0.9rem; color: #666; font-weight: 500;">Email</label>
                        <input type="email" id="resetEmail" placeholder="Enter your registered email"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-top: 4px;">
                    </div>
                </div>

                <div id="reset-message" style="display: none; margin-bottom: 15px; font-size: 0.9rem;"></div>

                <button class="google-btn" onclick="submitForgotPassword()"
                    style="background: var(--primary-color); color: white; border: none; margin-top: 10px; justify-content: center;">
                    Send Reset Link
                </button>

                <div style="margin-top: 20px;">
                    <a href="javascript:void(0)" onclick="showLogin()"
                        style="color: #666; text-decoration: none; font-size: 0.9rem;">
                        ‚Üê Back to Login
                    </a>
                </div>
            </div>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBihlwqIg2rvfKC-Tt6sjKYSFKYn7ZBJwg",
            authDomain: "foodly-40d16.firebaseapp.com",
            projectId: "foodly-40d16",
            storageBucket: "foodly-40d16.firebasestorage.app",
            messagingSenderId: "74040922594",
            appId: "1:74040922594:web:667204bc01d84c8db5e9bb"
        };
        firebase.initializeApp(firebaseConfig);

    </script>

    <script>
        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();
        const db = firebase.firestore();

        // üëá CHANGE THIS EMAIL TO YOUR ADMIN EMAIL
        const ADMIN_EMAIL = "tanklaksh.2007@gmail.com";

        // Auto-redirect if already logged in
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // If user just signed out, this might trigger with null, but here user is truthy.
                // We need to check if we are NOT in the middle of a login action, but usually this is safe.
                // Fetch role to decide where to go
                try {
                    const doc = await db.collection("users").doc(user.uid).get();
                    if (doc.exists) {
                        const data = doc.data();
                        let target = "menu.html";
                        if (data.role === 'admin' || data.role === 'author') target = "admin.html";

                        console.log("User already logged in, redirecting to", target);
                        window.location.replace(target);
                    }
                } catch (e) {
                    console.error("Error fetching user role for redirect:", e);
                }
            }
        });

        document.getElementById("googleLogin").addEventListener("click", () => {
            auth.signInWithPopup(provider)
                .then(async (result) => {
                    const user = result.user;
                    const isNewUser = result.additionalUserInfo.isNewUser;
                    // ‚úÖ GOOGLE ANALYTICS: Google Login
                    gtag('event', 'login', {
                        method: 'Google'
                    });


                    // Decide role
                    const role = user.email === ADMIN_EMAIL ? "admin" : "user";

                    // Save user to Firestore (merge true to not overwrite existing data if not new)
                    await db.collection("users").doc(user.uid).set({
                        name: user.displayName,
                        email: user.email,
                        role: role,
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });

                    // Redirect based on role
                    if (role === "admin") {
                        window.location.href = "admin.html";
                    } else {
                        if (isNewUser) {
                            window.location.href = "menu.html?setupProfile=true";
                        } else {
                            window.location.href = "menu.html";
                        }
                    }
                })
                .catch((error) => {
                    alert(error.message);
                });
        });

        function handleAdminLogin() {
            const provider = new firebase.auth.GoogleAuthProvider();

            firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                .then(() => {
                    return firebase.auth().signInWithPopup(provider);
                })
                .then(async (result) => {
                    const user = result.user;
                    // ‚úÖ GOOGLE ANALYTICS: Admin Login
                    gtag('event', 'login', {
                        method: 'Admin_Google'
                    });


                    if (user.email === ADMIN_EMAIL) {
                        // Save admin to Firestore (optional but good)
                        await db.collection("users").doc(user.uid).set({
                            name: user.displayName,
                            email: user.email,
                            role: "admin",
                            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });

                        // Redirect to admin panel
                        window.location.href = "admin.html";
                    } else {
                        alert("You are not authorized as Admin.");
                        await firebase.auth().signOut();
                    }
                })
                .catch((error) => {
                    alert(error.message);
                });
        }


        async function handleEmailLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                alert("Please enter both email and password");
                return;
            }

            try {
                await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                const userCredential = await auth.signInWithEmailAndPassword(email, password);// ‚úÖ GOOGLE ANALYTICS: Email Login
                gtag('event', 'login', {
                    method: 'Email'
                });

                const user = userCredential.user;

                // Check role in Firestore
                const doc = await db.collection("users").doc(user.uid).get();
                if (doc.exists) {
                    const userData = doc.data();
                    if (userData.role === 'admin' || userData.role === 'author') {
                        window.location.href = "admin.html";
                    } else {
                        window.location.href = "menu.html";
                    }
                } else {
                    // Fallback if no doc (shouldn't happen for registered users)
                    window.location.href = "menu.html";
                }

            } catch (error) {
                console.error("Login Error:", error);
                let errorMessage = "An error occurred during login.";

                if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errorMessage = "Login failed: Incorrect email or password.";
                } else if (error.code === 'auth/user-not-found') {
                    errorMessage = "Login failed: No account found with this email.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Login failed: Invalid email address.";
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = "Too many failed attempts. Please try again later.";
                } else {
                    errorMessage = error.message;
                }

                // alert(errorMessage);
                const errorDiv = document.getElementById("login-error");
                errorDiv.innerText = errorMessage;
                errorDiv.style.display = 'block';
            }
        }


        function showRegister() {
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('register-view').style.display = 'block';
            document.getElementById('forgot-password-view').style.display = 'none';
        }

        function showLogin() {
            document.getElementById('register-view').style.display = 'none';
            document.getElementById('forgot-password-view').style.display = 'none';
            document.getElementById('login-view').style.display = 'block';

            // Clear reset message if any
            document.getElementById('reset-message').style.display = 'none';
        }

        async function handleRegistration() {
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const phone = document.getElementById('regPhone').value;
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;

            if (!name || !email || !phone || !password || !confirmPassword) {
                alert("All fields are required");
                return;
            }

            if (phone.length !== 10) {
                alert("Please enter a valid 10-digit phone number");
                return;
            }

            if (password.length < 6) {
                alert("Password must be at least 6 characters");
                return;
            }

            if (password !== confirmPassword) {
                alert("Passwords do not match");
                return;
            }

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                // ‚úÖ GOOGLE ANALYTICS: New Registration
                gtag('event', 'sign_up', {
                    method: 'Email'
                });

                const user = userCredential.user;

                // Sync Name to Auth Profile (Crucial for Display Fallback)
                await user.updateProfile({
                    displayName: name
                });

                // Save to Firestore
                await db.collection("users").doc(user.uid).set({
                    name: name,
                    email: email,
                    phoneNumber: phone,
                    role: "user",
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert("Registration Successful!");
                window.location.href = "menu.html?setupProfile=true";
            } catch (error) {
                console.error("Registration Error:", error);
                const errorDiv = document.getElementById("register-error");
                errorDiv.innerText = error.message;
                errorDiv.style.display = 'block';
            }
        }

        function handleForgotPassword() {
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('register-view').style.display = 'none';
            document.getElementById('forgot-password-view').style.display = 'block';
        }

        function submitForgotPassword() {
            const email = document.getElementById('resetEmail').value.trim();
            const msgDiv = document.getElementById('reset-message');

            if (!email) {
                alert("Please enter your email address.");
                return;
            }

            if (!email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
                alert("Please enter a valid email address.");
                return;
            }

            auth.sendPasswordResetEmail(email)
                .then(() => {
                    alert("‚úÖ Reset link sent! Check your inbox.");
                    document.getElementById('resetEmail').value = "";
                    showLogin();
                })
                .catch((error) => {
                    console.error("Error sending reset email:", error);
                    msgDiv.style.display = "block";
                    if (error.code === 'auth/user-not-found') {
                        msgDiv.innerText = "‚ùå No account found with this email.";
                        msgDiv.style.color = "red";
                    } else {
                        msgDiv.innerText = "‚ùå Error: " + error.message;
                        msgDiv.style.color = "red";
                    }
                });
        }

        window.handleForgotPassword = handleForgotPassword;
    </script>
</body>

</html>