<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-VXEHBX2S2V"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }

        gtag('js', new Date());
        gtag('config', 'G-VXEHBX2S2V', {
            send_page_view: true
        });
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Foodly</title>
    <link rel="stylesheet" href="../css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Toastify CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Toastify JS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="../js/toast-utils.js"></script>
    <style>
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-md);
            background: linear-gradient(135deg, #fcebeb 0%, #e8fcfc 100%);
        }

        .login-card {
            width: 100%;
            max-width: 400px;
            text-align: center;
            padding: var(--spacing-xl);
        }

        .login-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto var(--spacing-lg);
            background: white;
            border-radius: 50%;
            padding: 10px;
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .login-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 50%;
        }

        .google-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: var(--radius-full);
            background: white;
            color: var(--text-color);
            font-weight: 500;
            transition: var(--transition);
            margin-top: var(--spacing-xl);
        }

        .google-btn:hover {
            background-color: #f8f8f8;
            box-shadow: var(--shadow-sm);
            transform: translateY(-1px);
        }

        .text-danger {
            color: #dc3545;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .skip-btn {
            display: none;
        }

        /* Hide old one if exists */

        .guest-btn-lg:hover {
            background: #fff5f5 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(255, 107, 107, 0.2);
        }

        /* =========================================
           RESPONSIVE DESIGN 
           ========================================= */

        /* Tablet & Small Laptop Optimization (< 1024px) */
        @media screen and (max-width: 1023px) {
            .login-container {
                padding: var(--spacing-md);
                /* Ensure padding exists */
                /* Flexbox centering is already inherited from desktop styles */
            }

            .login-card {
                /* Maintain center and max-width */
                margin: 0 auto;
            }
        }

        /* Mobile Optimization (< 768px) */
        @media screen and (max-width: 767px) {
            body {
                overflow-y: auto !important;
                /* Allow scrolling for landscape/small screens */
                height: auto;
                min-height: 100vh;
            }

            .login-container {
                padding: 10px;
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .login-card {
                width: 94vw !important;
                max-width: 400px;
                padding: 15px !important;
                margin: 10px auto;
                display: block;
                height: auto;
                max-height: none;
            }

            .login-logo {
                width: 60px;
                height: 60px;
                margin-bottom: 0.5rem !important;
                padding: 8px;
            }

            h1 {
                font-size: 1.3rem;
                margin-bottom: 0.25rem;
            }

            .text-muted {
                font-size: 0.8rem !important;
                margin-bottom: 1rem !important;
            }

            /* Touch-Friendly Inputs & Buttons */
            input,
            .google-btn,
            .guest-btn-lg {
                width: 100% !important;
                min-height: 44px !important;
                padding: 10px !important;
                font-size: 15px !important;
                /* Prevents iOS zoom */
            }

            .google-btn,
            button.google-btn {
                min-height: 46px !important;
                margin-top: 0.75rem !important;
            }

            input {
                margin-bottom: 4px !important;
                margin-top: 2px !important;
            }

            label {
                font-size: 0.85rem !important;
                margin-bottom: 2px !important;
                display: block;
            }

            .validation-msg {
                font-size: 0.7rem !important;
                white-space: normal !important;
                word-wrap: break-word;
                line-height: 1.2;
                margin-bottom: 8px !important;
            }

            /* Spacing adjustments for dense layouts */
            #register-view div[style*="gap: 0.75rem"] {
                gap: 0.4rem !important;
            }

            #login-view>div[style*="margin-bottom: 1.5rem"] {
                margin-bottom: 0.75rem !important;
            }

            #login-view>div[style*="margin: 1.5rem 0"] {
                margin: 0.75rem 0 !important;
            }

            div[style*="margin-top: 2rem"],
            div[style*="margin-top: 1.5rem"] {
                margin-top: 1rem !important;
                padding-top: 0.5rem;
            }

            .password-toggle-container {
                margin-top: 2px !important;
                margin-bottom: 4px !important;
            }
        }

        /* UX Enhancements */
        .password-toggle-container {
            position: relative;
            display: flex;
            align-items: center;
            margin-top: 4px;
        }

        .toggle-password-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            transition: color 0.3s;
            z-index: 5;
        }

        .toggle-password-btn:hover {
            color: var(--primary-color);
        }

        .toggle-password-btn svg {
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.2s;
            width: 18px;
            height: 18px;
        }

        .toggle-password-btn:active svg {
            transform: scale(0.8);
        }

        .validation-msg {
            font-size: 0.75rem;
            margin-top: 2px;
            display: block;
            min-height: 1rem;
        }

        .valid-input {
            border-color: #28a745 !important;
        }

        .invalid-input {
            border-color: #dc3545 !important;
        }

        .valid-text {
            color: #28a745;
        }

        .invalid-text {
            color: #dc3545;
        }

        .btn-spinner {
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
            display: none;
            margin-right: 8px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .btn-loading .btn-spinner {
            display: inline-block;
        }

        .btn-loading {
            pointer-events: none;
            opacity: 0.8;
        }
    </style>
</head>

<body>
    <div class="login-container">
        <div class="card login-card animate-fade-in">
            <div class="login-logo">
                <img src="../images/logo.png" alt="Foodly Logo">
            </div>

            <!-- LOGIN VIEW -->
            <div id="login-view">
                <h1>Welcome to Foodly</h1>
                <p class="text-muted">Order your favorite food for campus delivery.</p>

                <div style="text-align: left; margin-bottom: 1.5rem;">
                    <!-- GUEST BUTTON (Explicitly Above Input) -->
                    <a href="menu.html" class="guest-btn-lg animate-fade-in"
                        style="display: flex; justify-content: center; align-items: center; width: 100%; padding: 12px; border: 1px solid var(--primary-color); background: white; color: var(--primary-color); border-radius: 8px; font-weight: 600; text-decoration: none; margin-bottom: 20px; transition: all 0.3s ease;">
                        Continue as Guest ‚Üí
                    </a>
                    <div id="login-error" class="text-danger"
                        style="display:none; text-align: left; margin-bottom: 1rem;"></div>
                    <div>
                        <label style="font-size: 0.9rem; color: #666; font-weight: 500;">Email</label>
                        <input type="email" id="loginEmail" placeholder="Enter your email" autocomplete="off"
                            onkeypress="if(event.key === 'Enter') handleEmailLogin()"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-top: 4px; margin-bottom: 10px;">
                    </div>
                    <div>
                        <label style="font-size: 0.9rem; color: #666; font-weight: 500;">Password</label>
                        <div class="password-toggle-container">
                            <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password"
                                onkeypress="if(event.key === 'Enter') handleEmailLogin()"
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; padding-right: 40px;">
                            <button type="button" class="toggle-password-btn"
                                onclick="togglePasswordVisibility('loginPassword')">
                                <span class="eye-icon">
                                    <i data-lucide="eye"></i>
                                </span>
                            </button>
                        </div>
                        <div style="text-align: right; margin-top: 5px; margin-bottom: 15px;">
                            <a href="javascript:void(0)" onclick="handleForgotPassword()"
                                style="font-size: 0.85rem; color: var(--primary-color); text-decoration: none;">Forgot
                                Password?</a>
                        </div>
                    </div>
                    <button class="google-btn" onclick="handleEmailLogin()"
                        style="background: var(--primary-color); color: white; border: none; margin-top: 10px; justify-content: center;">
                        Login
                    </button>
                </div>

                <div style="display: flex; align-items: center; margin: 1.5rem 0;">
                    <div style="flex: 1; height: 1px; background: #eee;"></div>
                    <span style="padding: 0 10px; color: #999; font-size: 0.8rem;">OR</span>
                    <div style="flex: 1; height: 1px; background: #eee;"></div>
                </div>

                <button class="google-btn" id="googleLogin">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google"
                        width="20">
                    Sign in with Google
                </button>

                <!-- Old Guest Link Removed -->
                <div style="margin-top: 20px;">
                    <p class="text-sm text-muted">Or continue as <a href="#" onclick="handleAdminLogin()"
                            style="color: var(--primary-color)">Admin</a></p>
                </div>

                <div style="margin-top: 2rem; border-top: 1px solid #eee; padding-top: 1rem;">
                    <button onclick="showRegister()"
                        style="background: none; border: none; color: var(--primary-color); font-weight: 600; cursor: pointer;">
                        Create New Account
                    </button>
                </div>
            </div>


            <!-- REGISTER VIEW -->
            <div id="register-view" style="display: none;">
                <h1 style="margin-bottom: 1.5rem;">Create Account</h1>

                <div id="register-error" class="text-danger"
                    style="display:none; text-align: left; margin-bottom: 1rem;"></div>

                <div style="text-align: left; display: flex; flex-direction: column; gap: 0.75rem;">
                    <div>
                        <label style="font-size: 0.9rem; color: #666; font-weight: 500;">Full Name</label>
                        <input type="text" id="regName" placeholder="Enter your name"
                            onkeypress="if(event.key === 'Enter') handleRegistration()"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-top: 4px;">
                    </div>
                    <div>
                        <label style="font-size: 0.9rem; color: #666; font-weight: 500;">Email</label>
                        <input type="email" id="regEmail" placeholder="Enter your email"
                            onkeypress="if(event.key === 'Enter') handleRegistration()"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-top: 4px;">
                    </div>
                    <div>
                        <label style="font-size: 0.9rem; color: #666; font-weight: 500;">Mobile Number</label>
                        <input type="tel" id="regPhone" placeholder="Enter 10-digit number" maxlength="10"
                            onkeypress="if(event.key === 'Enter') handleRegistration()"
                            oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-top: 4px;">
                    </div>
                    <div>
                        <label style="font-size: 0.9rem; color: #666; font-weight: 500;">Password</label>
                        <div class="password-toggle-container">
                            <input type="password" id="regPassword" placeholder="Minimum 6 characters"
                                onkeypress="if(event.key === 'Enter') handleRegistration()"
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                            <button type="button" class="toggle-password-btn"
                                onclick="togglePasswordVisibility('regPassword')">
                                <span class="eye-icon">
                                    <i data-lucide="eye"></i>
                                </span>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label style="font-size: 0.9rem; color: #666; font-weight: 500;">Re-enter Password</label>
                        <div class="password-toggle-container">
                            <input type="password" id="regConfirmPassword" placeholder="Confirm Password"
                                onkeypress="if(event.key === 'Enter') handleRegistration()"
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                            <button type="button" class="toggle-password-btn"
                                onclick="togglePasswordVisibility('regConfirmPassword')">
                                <span class="eye-icon">
                                    <i data-lucide="eye"></i>
                                </span>
                            </button>
                        </div>
                    </div>
                </div>

                <button class="google-btn" id="regSubmitBtn" onclick="handleRegistration()"
                    style="background: var(--primary-color); color: white; border: none; margin-top: 1rem; justify-content: center;">
                    <span class="btn-spinner"></span>
                    <span class="btn-text">Create Account</span>
                </button>

                <div style="margin-top: 1.5rem;">
                    <p class="text-sm text-muted">Already have an account? <a href="#" onclick="showLogin()"
                            style="color: var(--primary-color)">Login</a></p>
                </div>
            </div>

            <!-- FORGOT PASSWORD VIEW -->
            <div id="forgot-password-view" style="display: none;">
                <h1 style="margin-bottom: 20px;">Reset Password</h1>
                <p class="text-muted" style="font-size: 0.9rem; margin-bottom: 20px;">Enter your email to receive a
                    reset link.</p>

                <div style="text-align: left; margin-bottom: 1.5rem;">
                    <div>
                        <label style="font-size: 0.9rem; color: #666; font-weight: 500;">Email</label>
                        <input type="email" id="resetEmail" placeholder="Enter your registered email"
                            onkeypress="if(event.key === 'Enter') submitForgotPassword()"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-top: 4px;">
                    </div>
                </div>

                <div id="reset-message" style="display: none; margin-bottom: 15px; font-size: 0.9rem;"></div>

                <button class="google-btn" onclick="submitForgotPassword()"
                    style="background: var(--primary-color); color: white; border: none; margin-top: 10px; justify-content: center;">
                    Send Reset Link
                </button>

                <div style="margin-top: 20px;">
                    <a href="javascript:void(0)" onclick="showLogin()"
                        style="color: #666; text-decoration: none; font-size: 0.9rem;">
                        ‚Üê Back to Login
                    </a>
                </div>
            </div>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>


    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
    <script>
        (function () {
            emailjs.init("4XCCsOQQDfpwybonc");
        })();
    </script>

    <!-- Toast Utility -->
    <script src="../js/toast-utils.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBihlwqIg2rvfKC-Tt6sjKYSFKYn7ZBJwg",
            authDomain: "foodly-40d16.firebaseapp.com",
            projectId: "foodly-40d16",
            storageBucket: "foodly-40d16.firebasestorage.app",

            appId: "1:74040922594:web:667204bc01d84c8db5e9bb"
        };
        firebase.initializeApp(firebaseConfig);

    </script>

    <script>
        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();
        const db = firebase.firestore();








        async function sendWelcomeEmail(userEmail, userName) {
            if (!userEmail) {
                console.warn("No email provided for welcome email");
                return Promise.resolve();
            }

            const templateParams = {
                email: userEmail,
                name: userName || "Foodly User",
                to_email: userEmail,
                to_name: userName || "Foodly User",
                user_email: userEmail,
                user_name: userName || "Foodly User"
            };

            console.log("üì® Sending welcome email to:", userEmail);

            try {
                const response = await emailjs.send(
                    "service_4hy0432",
                    "template_b31vsep",
                    templateParams,
                    "4XCCsOQQDfpwybonc"
                );
                console.log("‚úÖ Welcome email sent successfully!", response);
                return response;
            } catch (error) {
                console.error("‚ùå Email send failed:", error);
                // Don't throw - we don't want to block registration
                return null;
            }
        }

        // üëá CHANGE THIS EMAIL TO YOUR ADMIN EMAIL
        const ADMIN_EMAIL = "foodly.mail.service@gmail.com";

        let isLoginInProgress = false;

        // Auto-redirect if already logged in
        auth.onAuthStateChanged(async (user) => {
            if (user && !isLoginInProgress) {
                // If user just signed out, this might trigger with null, but here user is truthy.
                // We need to check if we are NOT in the middle of a login action, but usually this is safe.
                // Fetch role to decide where to go
                try {
                    const doc = await db.collection("users").doc(user.uid).get();
                    if (doc.exists) {
                        const data = doc.data();
                        let target = "menu.html";
                        if (data.role === 'admin' || data.role === 'author') target = "admin.html";

                        console.log("User already logged in, redirecting to", target);
                        window.location.replace(target);
                    }
                } catch (e) {
                    console.error("Error fetching user role for redirect:", e);
                }
            }
        });

        /* Registration UX Logic */
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const iconContainer = input.nextElementSibling.querySelector('.eye-icon');

            if (input.type === 'password') {
                input.type = 'text';
                iconContainer.innerHTML = '<i data-lucide="eye-off"></i>';
            } else {
                input.type = 'password';
                iconContainer.innerHTML = '<i data-lucide="eye"></i>';
            }
            lucide.createIcons();
        }

        // Validation functions removed as per user request to stop warnings during typing


        // Live validation listeners removed as per user request
        document.addEventListener('DOMContentLoaded', () => {
        });

        document.getElementById("googleLogin").addEventListener("click", () => {
            isLoginInProgress = true;
            auth.signInWithPopup(provider)
                .then(async (result) => {
                    const user = result.user;



                    // Check if new user in Firestore
                    const docSnap = await db.collection("users").doc(user.uid).get();
                    const isNewlyRegistered = !docSnap.exists;

                    // ‚úÖ GOOGLE ANALYTICS: Google Login
                    gtag('event', 'login', {
                        method: 'Google'
                    });

                    // Decide role
                    const role = user.email === ADMIN_EMAIL ? "admin" : "user";

                    // Save user to Firestore
                    await db.collection("users").doc(user.uid).set({
                        name: user.displayName,
                        email: user.email,
                        role: role,
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });

                    // Redirect or Welcome Email
                    if (role === "admin") {
                        window.location.href = "admin.html";
                    } else {
                        if (isNewlyRegistered) {
                            await sendWelcomeEmail(user.email, user.displayName);
                            window.location.href = "menu.html?setupProfile=true";
                        } else {
                            window.location.href = "menu.html";
                        }
                    }
                })
                .catch((error) => {
                    isLoginInProgress = false;
                    console.error("Google Login Error:", error);
                    toast.error(error.message);
                });
        });

        function handleAdminLogin() {
            const provider = new firebase.auth.GoogleAuthProvider();
            isLoginInProgress = true;

            firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                .then(() => {
                    return firebase.auth().signInWithPopup(provider);
                })
                .then(async (result) => {
                    const user = result.user;



                    // ‚úÖ GOOGLE ANALYTICS: Admin Login
                    gtag('event', 'login', {
                        method: 'Admin_Google'
                    });


                    if (user.email === ADMIN_EMAIL) {
                        // Save admin to Firestore
                        await db.collection("users").doc(user.uid).set({
                            name: user.displayName,
                            email: user.email,
                            role: "admin",
                            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });

                        // Redirect to admin panel
                        window.location.href = "admin.html";
                    } else {
                        toast.error("You are not authorized as Admin.");
                        isLoginInProgress = false;
                        await firebase.auth().signOut();
                    }
                })
                .catch((error) => {
                    isLoginInProgress = false;
                    toast.error(error.message);
                });
        }


        async function handleEmailLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                toast.warning("Please enter both email and password");
                return;
            }

            isLoginInProgress = true;
            try {
                await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                const userCredential = await auth.signInWithEmailAndPassword(email, password);// ‚úÖ GOOGLE ANALYTICS: Email Login
                gtag('event', 'login', {
                    method: 'Email'
                });

                const user = userCredential.user;

                // Check role in Firestore
                const doc = await db.collection("users").doc(user.uid).get();
                if (doc.exists) {
                    const userData = doc.data();
                    if (userData.role === 'admin' || userData.role === 'author') {
                        window.location.href = "admin.html";
                    } else {
                        window.location.href = "menu.html";
                    }
                } else {
                    // Fallback if no doc (shouldn't happen for registered users)
                    window.location.href = "menu.html";
                }

            } catch (error) {
                isLoginInProgress = false;
                console.error("Login Error:", error);
                let errorMessage = "An error occurred during login.";

                if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errorMessage = "Login failed: Incorrect email or password.";
                } else if (error.code === 'auth/user-not-found') {
                    errorMessage = "Login failed: No account found with this email.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Login failed: Invalid email address.";
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = "Too many failed attempts. Please try again later.";
                } else {
                    errorMessage = error.message;
                }

                // alert(errorMessage);
                const errorDiv = document.getElementById("login-error");
                errorDiv.innerText = errorMessage;
                errorDiv.style.display = 'block';
            }
        }


        function showRegister() {
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('register-view').style.display = 'block';
            document.getElementById('forgot-password-view').style.display = 'none';
        }

        function showLogin() {
            document.getElementById('register-view').style.display = 'none';
            document.getElementById('forgot-password-view').style.display = 'none';
            document.getElementById('login-view').style.display = 'block';

            // Clear reset message if any
            document.getElementById('reset-message').style.display = 'none';
        }

        async function handleRegistration() {
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const phone = document.getElementById('regPhone').value;
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;

            if (!name || !email || !phone || !password || !confirmPassword) {
                toast.warning("All fields are required");
                return;
            }

            if (phone.length !== 10) {
                toast.warning("Please enter a valid 10-digit phone number");
                return;
            }

            if (password.length < 6) {
                toast.warning("Password must be at least 6 characters");
                return;
            }

            // Strong Password Logic: 1 capital, 1 digit, 1 special character
            const strongPasswordRegex = /^(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{6,}$/;
            if (!strongPasswordRegex.test(password)) {
                toast.warning("Password must contain at least one capital letter, one digit, and one special character.");
                return;
            }

            if (password !== confirmPassword) {
                toast.warning("Passwords do not match");
                return;
            }

            const submitBtn = document.getElementById('regSubmitBtn');
            submitBtn.classList.add('btn-loading');
            submitBtn.disabled = true;

            isLoginInProgress = true;
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                // ‚úÖ GOOGLE ANALYTICS: New Registration
                gtag('event', 'sign_up', {
                    method: 'Email'
                });

                const user = userCredential.user;

                // Sync Name to Auth Profile (Crucial for Display Fallback)
                await user.updateProfile({
                    displayName: name
                });

                // Save to Firestore
                await db.collection("users").doc(user.uid).set({
                    name: name,
                    email: email,
                    phoneNumber: phone,
                    role: "user",
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Send welcome email and wait for it
                await sendWelcomeEmail(email, name);

                toast.success("Registration Successful! Redirecting...");

                // Small delay to ensure auth state is synced before redirect
                setTimeout(() => {
                    window.location.href = "menu.html?setupProfile=true";
                }, 300);
            } catch (error) {
                isLoginInProgress = false;
                if (submitBtn) {
                    submitBtn.classList.remove('btn-loading');
                    submitBtn.disabled = false;
                }
                console.error("Registration Error:", error);
                const errorDiv = document.getElementById("register-error");
                errorDiv.innerText = error.message;
                errorDiv.style.display = 'block';
            }
        }

        function handleForgotPassword() {
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('register-view').style.display = 'none';
            document.getElementById('forgot-password-view').style.display = 'block';
        }

        function submitForgotPassword() {
            const email = document.getElementById('resetEmail').value.trim();
            const msgDiv = document.getElementById('reset-message');

            if (!email) {
                toast.warning("Please enter your email address.");
                return;
            }

            if (!email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
                toast.warning("Please enter a valid email address.");
                return;
            }

            auth.sendPasswordResetEmail(email)
                .then(() => {
                    toast.success("Reset link sent! Check your inbox.");
                    document.getElementById('resetEmail').value = "";
                    showLogin();
                })
                .catch((error) => {
                    console.error("Error sending reset email:", error);
                    msgDiv.style.display = "block";
                    if (error.code === 'auth/user-not-found') {
                        msgDiv.innerText = "‚ùå No account found with this email.";
                        msgDiv.style.color = "red";
                    } else {
                        msgDiv.innerText = "‚ùå Error: " + error.message;
                        msgDiv.style.color = "red";
                    }
                });
        }

        window.handleForgotPassword = handleForgotPassword;
    </script>
    <script>
        lucide.createIcons();
    </script>
</body>

</html>